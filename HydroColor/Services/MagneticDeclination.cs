
namespace HydroColor.Services
{
    public static class MagneticDeclination
    {
        public static double GetDeclination(double lat, double lon)
        {
            // first longitude in the table less than the specified value (on the western side)
            int LonIdxW = Array.FindLastIndex(Longitude, x => x <= lon); 
            // first latitude in the table less than the specified value (on the southern side)
            int LatIdxS = Array.FindIndex(Latitude, x => x <= lat);

            double decSW = DeclinationTable[LatIdxS ,LonIdxW];
            double decSE = DeclinationTable[LatIdxS, LonIdxW + 1];
            double decNE = DeclinationTable[LatIdxS - 1, LonIdxW + 1];
            double decNW = DeclinationTable[LatIdxS - 1, LonIdxW];

            // Bilinear interpolation
            //
            //      decNorth
            // NW          \    NE
            // *------------*---*
            // |            |   |
            // |            |   |
            // |------------*---|
            // |          / |   |
            // |      Mdec  |   |
            // |            |   |
            // |            |   |
            // *------------*---*
            // SW          /   SE
            //      decSouth
            //
            // Declination table has 5 degree spacing in both lat and lon

            double decSouth = (lon - Longitude[LonIdxW]) / 5.0 * (decSE - decSW) + decSW;
            double decNorth = (lon - Longitude[LonIdxW]) / 5.0 * (decNE - decNW) + decNW;
            double Mdec = (lat - Latitude[LatIdxS]) / 5.0 * (decNorth - decSouth) + decSouth;
            return Mdec;
        }

        public static double[] Latitude = new double[33] { 80, 75, 70, 65, 60, 55, 50, 45, 40, 35, 30, 25, 20, 15, 10, 5, 0, -5, -10, -15, -20, -25, -30, -35, -40, -45, -50, -55, -60, -65, -70, -75, -80 };
        public static double[] Longitude = new double[73] { -180, -175, -170, -165, -160, -155, -150, -145, -140, -135, -130, -125, -120, -115, -110, -105, -100, -95, -90, -85, -80, -75, -70, -65, -60, -55, -50, -45, -40, -35, -30, -25, -20, -15, -10, -5, 0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100, 105, 110, 115, 120, 125, 130, 135, 140, 145, 150, 155, 160, 165, 170, 175, 180 };

        // Table generated from https://www.ngdc.noaa.gov/geomag/calculators/magcalc.shtml#igrfgrid for
        // Lat: 80:5:-80
        // Lon: -180:5:180
        public static Int16[,] DeclinationTable = new Int16[33, 73]
        {
            {-4,-2,1,4,6,8,10,11,12,12,11,9,5,-2,-10,-19,-28,-35,-40,-43,-44,-45,-44,-42,-40,-38,-35,-32,-29,-26,-22,-19,-15,-11,-7,-4,0,4,8,12,15,19,23,26,30,33,36,39,42,44,46,48,48,48,46,42,35,25,13,1,-8,-14,-18,-20,-20,-20,-18,-16,-14,-12,-9,-7,-4},
            {-1,1,4,7,9,12,14,16,18,19,19,18,16,13,7,0,-9,-18,-25,-31,-35,-37,-38,-37,-36,-34,-32,-30,-27,-24,-21,-18,-14,-11,-8,-4,-1,3,6,10,13,16,19,22,25,28,31,33,34,36,36,36,35,32,27,20,12,4,-4,-11,-15,-18,-19,-20,-19,-18,-16,-14,-12,-9,-7,-4,-1},
            {0,3,5,8,11,13,15,17,19,20,20,20,19,17,13,7,-0,-8,-16,-22,-27,-30,-31,-32,-32,-30,-29,-27,-24,-22,-19,-16,-13,-10,-7,-4,-1,2,5,8,11,14,17,19,22,24,26,27,28,29,28,27,25,21,16,10,4,-3,-8,-13,-16,-18,-18,-18,-18,-16,-14,-12,-10,-8,-5,-3,0},
            {1,3,6,8,11,13,15,17,19,20,20,20,19,17,14,9,3,-3,-10,-16,-21,-24,-26,-27,-27,-26,-25,-23,-21,-19,-17,-14,-11,-9,-6,-3,-1,2,4,7,9,12,14,16,18,20,21,22,23,23,22,20,18,15,10,5,0,-5,-9,-13,-15,-17,-17,-17,-16,-15,-13,-11,-9,-7,-4,-2,1},
            {1,4,6,9,11,13,15,17,18,19,19,19,18,16,13,9,5,-1,-7,-12,-16,-20,-22,-23,-23,-23,-22,-20,-19,-17,-14,-12,-10,-7,-5,-2,-0,2,4,6,8,10,12,13,15,16,17,18,18,18,17,15,13,10,7,3,-1,-5,-9,-12,-14,-15,-16,-16,-15,-14,-12,-10,-8,-6,-3,-1,1},
            {2,4,7,9,11,13,15,16,17,18,18,18,17,15,12,9,5,0,-5,-9,-13,-17,-19,-20,-21,-20,-19,-18,-16,-14,-12,-10,-8,-6,-4,-2,0,2,4,5,7,8,10,11,12,13,14,14,14,14,13,12,10,7,5,1,-2,-5,-8,-11,-13,-14,-14,-14,-13,-12,-11,-9,-7,-5,-3,-0,2},
            {3,5,7,9,11,12,14,15,16,17,17,16,15,14,12,9,5,1,-3,-8,-12,-15,-17,-18,-18,-18,-17,-16,-15,-13,-11,-9,-7,-5,-3,-1,1,2,4,5,6,7,8,9,10,10,11,11,11,10,10,9,7,5,3,1,-2,-5,-7,-9,-11,-12,-13,-13,-12,-11,-10,-8,-6,-4,-2,0,3},
            {3,5,7,9,11,12,13,14,15,16,16,15,14,13,11,8,5,1,-3,-7,-10,-13,-15,-16,-17,-17,-16,-15,-13,-12,-10,-8,-6,-4,-2,-0,1,2,3,4,5,6,7,7,8,8,8,8,8,8,7,6,5,4,2,0,-2,-4,-6,-8,-10,-11,-11,-11,-11,-10,-8,-7,-5,-3,-1,1,3},
            {4,6,8,9,10,12,13,14,14,14,14,14,13,12,10,8,5,2,-2,-6,-9,-12,-14,-15,-16,-16,-15,-14,-13,-11,-9,-7,-5,-4,-2,-0,1,2,3,4,5,5,6,6,6,6,6,6,6,6,5,4,4,2,1,-0,-2,-4,-5,-7,-8,-9,-10,-10,-9,-8,-7,-5,-3,-1,1,2,4},
            {5,7,8,9,10,11,12,13,13,13,13,13,12,11,9,7,5,2,-2,-5,-8,-11,-13,-15,-15,-15,-15,-14,-12,-11,-9,-7,-5,-3,-2,-0,1,2,3,4,4,5,5,5,5,5,5,5,4,4,3,3,2,1,1,-1,-2,-3,-5,-6,-7,-8,-8,-8,-8,-7,-5,-4,-2,0,2,4,5},
            {6,8,8,9,10,11,11,12,12,12,12,12,11,10,9,7,5,2,-1,-5,-8,-11,-13,-14,-15,-15,-15,-14,-12,-11,-9,-7,-5,-4,-2,-0,1,2,3,3,4,4,5,5,5,4,4,3,3,3,2,2,1,1,0,-1,-2,-3,-4,-5,-6,-7,-7,-7,-6,-5,-3,-2,-0,2,3,5,6},
            {7,8,9,9,10,10,10,11,11,11,11,11,10,9,8,6,4,2,-1,-4,-7,-10,-12,-14,-15,-15,-15,-14,-13,-11,-10,-8,-6,-4,-2,-1,0,1,2,3,3,4,4,4,4,3,3,2,2,1,1,1,0,0,-0,-1,-1,-2,-3,-4,-5,-5,-5,-5,-4,-3,-2,-0,2,3,5,6,7},
            {8,9,9,9,9,10,10,10,10,10,10,10,9,9,8,6,4,2,-0,-3,-6,-9,-12,-14,-15,-16,-16,-15,-14,-12,-11,-9,-6,-5,-3,-1,-0,1,2,2,3,4,4,4,3,3,2,1,1,1,0,-0,-0,-1,-1,-1,-1,-2,-2,-3,-4,-4,-4,-3,-3,-1,-0,1,3,5,6,7,8},
            {9,9,9,9,9,9,9,10,10,10,9,9,9,8,7,6,5,3,0,-3,-6,-9,-11,-14,-16,-17,-17,-16,-15,-14,-12,-10,-7,-5,-4,-2,-1,0,1,2,3,3,4,3,3,2,1,1,0,-0,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-3,-3,-3,-2,-1,0,1,3,4,6,7,8,9},
            {9,9,9,9,9,9,9,9,9,9,9,9,8,8,7,6,5,3,1,-2,-5,-8,-11,-14,-16,-17,-18,-18,-17,-15,-13,-11,-9,-7,-5,-3,-2,-1,1,2,2,3,3,3,2,1,0,-0,-1,-1,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-1,0,1,3,4,6,7,8,9,9},
            {10,10,9,9,9,9,9,9,9,9,9,8,8,8,7,7,5,4,2,-1,-4,-8,-11,-14,-16,-18,-19,-19,-18,-17,-15,-13,-10,-8,-6,-4,-3,-1,-0,1,2,3,3,2,1,0,-1,-1,-2,-2,-3,-3,-2,-2,-1,-1,-0,-0,-0,-1,-1,-1,-0,0,1,3,4,5,7,8,9,9,10},
            {10,10,10,10,9,9,9,9,9,9,9,9,8,8,8,7,6,5,3,-0,-3,-7,-10,-14,-16,-18,-20,-20,-20,-19,-17,-15,-12,-10,-8,-6,-4,-3,-1,0,1,2,2,1,0,-1,-2,-3,-4,-4,-4,-4,-3,-3,-2,-1,-0,0,0,0,-0,-0,0,1,2,4,5,6,7,8,9,10,10},
            {10,10,10,10,10,10,10,10,10,10,9,9,9,9,8,8,7,6,4,1,-2,-6,-10,-13,-16,-19,-21,-21,-21,-20,-19,-17,-15,-13,-10,-8,-6,-4,-2,-1,0,1,0,-0,-2,-3,-4,-5,-6,-6,-6,-5,-5,-4,-2,-1,-0,0,1,1,1,1,1,2,3,4,6,7,8,9,10,10,10},
            {11,11,11,11,11,11,11,11,11,11,10,10,10,9,9,9,8,7,5,2,-1,-5,-9,-13,-16,-19,-21,-22,-23,-22,-21,-20,-18,-16,-13,-11,-9,-6,-4,-3,-2,-1,-2,-3,-5,-6,-7,-8,-9,-9,-8,-7,-6,-5,-3,-2,-1,0,1,1,1,1,2,3,4,5,7,8,9,10,10,11,11},
            {12,12,12,12,12,12,12,12,12,12,12,11,11,11,10,10,9,8,6,4,0,-4,-8,-12,-16,-19,-21,-23,-24,-24,-23,-22,-21,-19,-17,-14,-12,-9,-7,-5,-5,-5,-6,-7,-9,-11,-12,-12,-13,-12,-11,-10,-9,-7,-5,-3,-1,-0,0,1,1,2,3,4,5,6,7,9,10,11,11,12,12},
            {13,14,14,14,14,14,14,14,14,13,13,13,12,12,12,12,11,10,8,6,2,-2,-6,-11,-15,-18,-21,-23,-24,-24,-25,-24,-23,-22,-20,-18,-15,-13,-11,-9,-9,-10,-11,-13,-15,-17,-18,-18,-18,-17,-16,-14,-12,-10,-7,-5,-3,-1,-0,1,1,2,3,4,6,7,8,10,11,12,13,13,13},
            {15,15,15,16,16,16,16,15,15,15,15,14,14,14,14,14,13,12,10,8,4,0,-4,-9,-13,-17,-20,-22,-24,-24,-25,-25,-25,-24,-23,-21,-19,-17,-15,-15,-15,-17,-19,-21,-22,-24,-25,-25,-24,-23,-21,-19,-17,-14,-11,-8,-5,-3,-1,-0,1,2,4,5,6,8,9,11,12,13,14,15,15},
            {17,17,18,18,18,18,18,18,17,17,17,17,17,16,16,16,16,15,13,10,7,3,-2,-7,-11,-15,-18,-21,-22,-24,-24,-25,-25,-24,-24,-22,-21,-20,-20,-20,-22,-24,-26,-28,-30,-32,-32,-32,-32,-30,-28,-26,-23,-19,-16,-12,-9,-6,-3,-1,0,2,4,6,7,9,11,13,14,15,16,17,17},
            {20,20,20,20,20,20,20,20,20,20,19,19,19,19,19,19,18,17,16,13,10,6,1,-4,-8,-12,-16,-18,-20,-22,-23,-23,-23,-23,-23,-22,-22,-22,-23,-25,-27,-30,-33,-35,-37,-39,-39,-40,-39,-38,-36,-33,-30,-26,-22,-18,-14,-10,-6,-3,-1,2,4,6,9,11,13,15,16,17,18,19,20},
            {23,23,23,23,23,23,23,23,23,23,22,22,22,22,22,22,21,20,18,16,12,9,4,-0,-5,-9,-12,-15,-17,-19,-20,-20,-21,-21,-21,-21,-22,-23,-25,-28,-31,-34,-37,-40,-42,-44,-45,-46,-46,-45,-44,-42,-39,-35,-31,-26,-21,-16,-11,-7,-3,1,4,7,10,13,15,17,19,20,21,22,23},
            {26,27,27,27,27,27,26,26,26,26,26,26,26,26,26,25,24,23,21,18,15,11,7,3,-1,-5,-8,-11,-13,-15,-16,-17,-18,-18,-19,-20,-22,-24,-26,-30,-33,-36,-40,-43,-46,-48,-50,-51,-52,-52,-51,-50,-48,-45,-41,-36,-31,-25,-18,-12,-7,-1,4,8,12,15,18,21,23,24,25,26,26},
            {31,32,32,32,31,31,31,31,30,30,30,30,30,30,29,28,27,26,23,21,18,14,10,7,3,-1,-4,-7,-9,-11,-12,-13,-14,-16,-17,-19,-21,-24,-27,-30,-34,-38,-41,-45,-48,-51,-53,-55,-56,-57,-58,-58,-57,-55,-52,-49,-44,-37,-30,-22,-13,-5,2,9,14,19,23,25,28,29,30,31,31},
            {38,38,38,38,37,37,36,36,36,35,35,35,34,34,33,32,30,28,26,23,20,17,13,10,6,3,0,-3,-5,-7,-9,-10,-12,-13,-15,-18,-20,-24,-27,-31,-34,-38,-42,-46,-49,-52,-55,-58,-60,-62,-63,-64,-65,-65,-64,-62,-59,-55,-49,-40,-28,-15,-2,9,18,25,30,33,35,37,38,38,38},
            {48,48,47,46,45,44,44,43,42,41,41,40,39,38,37,35,33,31,28,26,23,19,16,13,10,7,4,1,-1,-3,-5,-8,-10,-12,-14,-17,-20,-23,-27,-31,-35,-39,-43,-46,-50,-54,-57,-60,-63,-66,-68,-70,-72,-74,-75,-76,-76,-76,-74,-70,-62,-46,-20,9,28,38,44,47,48,49,49,49,48},
            {64,62,60,58,56,55,53,52,51,49,48,46,45,43,41,39,36,34,31,28,25,22,19,16,13,10,7,5,2,-1,-3,-6,-8,-11,-14,-17,-20,-24,-27,-31,-35,-39,-43,-47,-51,-55,-59,-62,-66,-69,-73,-76,-79,-82,-85,-88,-91,-94,-97,-101,-105,-111,-122,-160,112,90,82,77,74,71,68,66,64},
            {86,82,78,74,71,69,66,63,61,58,56,54,51,49,46,44,41,38,35,32,29,26,22,19,16,13,10,7,4,1,-1,-4,-7,-10,-14,-17,-21,-24,-28,-32,-36,-40,-44,-48,-52,-57,-61,-65,-69,-73,-77,-81,-85,-89,-94,-98,-103,-108,-114,-121,-128,-138,-150,-166,176,156,138,124,112,104,97,91,86},
            {110,104,99,94,89,85,81,77,73,70,66,63,59,56,53,50,46,43,40,36,33,30,26,23,19,16,13,10,6,3,-0,-4,-7,-11,-14,-18,-22,-25,-29,-33,-38,-42,-46,-50,-55,-59,-63,-68,-72,-77,-82,-86,-91,-96,-101,-106,-112,-118,-124,-131,-139,-147,-156,-166,-176,173,162,152,142,133,124,117,110},
            {129,123,117,111,106,101,96,91,86,82,77,73,69,65,61,57,53,49,45,42,38,34,30,26,23,19,15,11,8,4,0,-4,-8,-11,-15,-19,-23,-28,-32,-36,-40,-45,-49,-54,-58,-63,-67,-72,-77,-82,-87,-92,-97,-102,-108,-113,-119,-125,-131,-138,-144,-151,-158,-166,-173,179,172,164,157,150,143,136,129}
        };

    }
}
